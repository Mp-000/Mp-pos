<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>POS Enterprise - Transaksi & Cicilan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<script>
// ===== AUTH =====
const loginUser = JSON.parse(localStorage.getItem('loginUser'));
if(!loginUser || !['Kasir','Admin','Super Admin'].includes(loginUser.role)){
  location.href='login.html';
}
</script>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">POS Transaksi</span>
    <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container-fluid mt-3">
  <div class="row">

    <!-- PRODUK -->
    <div class="col-md-7">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">Produk</div>
        <div class="card-body">
          <div class="row" id="productList"></div>
        </div>
      </div>
    </div>

    <!-- KERANJANG -->
    <div class="col-md-5">
      <div class="card shadow">
        <div class="card-header bg-success text-white">Keranjang</div>
        <div class="card-body">
          <table class="table table-sm">
            <thead>
              <tr><th>Produk</th><th>Qty</th><th>Subtotal</th><th></th></tr>
            </thead>
            <tbody id="cartTable"></tbody>
          </table>
          <h5>Total: Rp <span id="total">0</span></h5>

          <select id="payment" class="form-select mb-2" onchange="paymentChange()">
            <option value="">-- Metode Pembayaran --</option>
            <option value="Cash">Cash</option>
            <option value="Transfer">Transfer</option>
            <option value="Kredit">Kredit / Cicilan</option>
          </select>

          <div id="paymentForm"></div>

          <button class="btn btn-primary w-100 mt-2" onclick="checkout()">Proses Transaksi</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
let products = JSON.parse(localStorage.getItem('products')) || [];
let transaksi = JSON.parse(localStorage.getItem('transaksi')) || [];
let cart = [];

function renderProducts(){
  productList.innerHTML='';
  products.forEach((p,i)=>{
    productList.innerHTML += `
      <div class="col-md-4 mb-2">
        <div class="card h-100">
          <div class="card-body">
            <h6>${p.nama}</h6>
            <p>Rp ${p.jual}</p>
            <small>Stok: ${p.stok}</small><br>
            <button class="btn btn-sm btn-success mt-1" onclick="addCart(${i})">Tambah</button>
          </div>
        </div>
      </div>`;
  });
}

function addCart(i){
  if(products[i].stok<=0){ Swal.fire('Stok habis','','error'); return; }
  const item = cart.find(c=>c.i===i);
  if(item) item.qty++;
  else cart.push({i,qty:1});
  renderCart();
}

function renderCart(){
  cartTable.innerHTML='';
  let total=0;
  cart.forEach((c,idx)=>{
    const p = products[c.i];
    const sub = p.jual*c.qty;
    total+=sub;
    cartTable.innerHTML+=`
      <tr>
        <td>${p.nama}</td>
        <td>${c.qty}</td>
        <td>Rp ${sub}</td>
        <td><button class="btn btn-danger btn-sm" onclick="remove(${idx})">x</button></td>
      </tr>`;
  });
  document.getElementById('total').innerText=total;
}

function remove(i){ cart.splice(i,1); renderCart(); }

function paymentChange(){
  const p = payment.value;
  if(p==='Cash'){
    paymentForm.innerHTML='<input id="bayar" type="number" class="form-control" placeholder="Uang Bayar">';
  } else if(p==='Transfer'){
    paymentForm.innerHTML='<input id="tf" class="form-control" placeholder="No. Referensi Transfer">';
  } else if(p==='Kredit'){
    paymentForm.innerHTML=`
      <input id="dp" type="number" class="form-control mb-1" placeholder="Uang Muka (DP)">
      <select id="tenor" class="form-select">
        <option value="1">1 Bulan</option>
        <option value="3">3 Bulan</option>
        <option value="6">6 Bulan</option>
        <option value="12">12 Bulan</option>
      </select>`;
  } else paymentForm.innerHTML='';
}

function checkout(){
  if(cart.length===0){ Swal.fire('Keranjang kosong','','warning'); return; }
  const total = +document.getElementById('total').innerText;
  const metode = payment.value;
  let status='Lunas';

  if(metode==='Kredit') status='Belum Lunas';

  transaksi.push({
    tanggal:new Date().toLocaleString(),
    total,
    metode,
    status
  });

  cart.forEach(c=>products[c.i].stok-=c.qty);

  localStorage.setItem('products',JSON.stringify(products));
  localStorage.setItem('transaksi',JSON.stringify(transaksi));

  Swal.fire('Berhasil','Transaksi disimpan','success');
  cart=[]; renderCart(); renderProducts();
}

function logout(){ localStorage.removeItem('loginUser'); location.href='login.html'; }

renderProducts();
</script>
</body>
</html>
