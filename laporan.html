<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Invoice Transaksi - POS Enterprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<script>
// ===== AUTH =====
const loginUser = JSON.parse(localStorage.getItem('loginUser'));
if(!loginUser){ location.href='login.html'; }
</script>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Invoice & Cicilan</span>
    <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container mt-3">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">Daftar Invoice</div>
    <div class="card-body">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>No Invoice</th>
            <th>Tanggal</th>
            <th>Total</th>
            <th>Metode</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal fade" id="detailModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5>Detail Invoice</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detail"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let transaksi = JSON.parse(localStorage.getItem('transaksi')) || [];

// Tambahkan nomor invoice jika belum ada
transaksi.forEach((t,i)=>{
  if(!t.invoice){
    t.invoice = 'INV-'+(i+1).toString().padStart(5,'0');
    if(t.metode==='Kredit'){
      t.sisa = t.total;
      t.cicilan = [];
    }
  }
});
localStorage.setItem('transaksi',JSON.stringify(transaksi));

function render(){
  table.innerHTML='';
  transaksi.forEach(t=>{
    table.innerHTML+=`
      <tr>
        <td>${t.invoice}</td>
        <td>${t.tanggal}</td>
        <td>Rp ${t.total}</td>
        <td>${t.metode}</td>
        <td>${t.status}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick="detailInvoice('${t.invoice}')">Detail</button>
        </td>
      </tr>`;
  });
}

function detailInvoice(no){
  const t = transaksi.find(x=>x.invoice===no);
  let html = `
    <p><b>Invoice:</b> ${t.invoice}</p>
    <p><b>Tanggal:</b> ${t.tanggal}</p>
    <p><b>Total:</b> Rp ${t.total}</p>
    <p><b>Metode:</b> ${t.metode}</p>
    <p><b>Status:</b> ${t.status}</p>`;

  if(t.metode==='Kredit'){
    html += `<hr><h6>Pembayaran Cicilan</h6>`;
    html += `<p>Sisa: Rp ${t.sisa}</p>`;
    html += `<input id="bayarCicil" type="number" class="form-control" placeholder="Bayar Cicilan">`;
    html += `<button class="btn btn-success mt-2" onclick="bayar('${t.invoice}')">Bayar</button>`;

    if(t.cicilan.length>0){
      html += '<ul class="mt-2">';
      t.cicilan.forEach(c=>html+=`<li>${c.tgl} - Rp ${c.jumlah}</li>`);
      html+='</ul>';
    }
  }

  detail.innerHTML=html;
  new bootstrap.Modal(detailModal).show();
}

function bayar(no){
  const t = transaksi.find(x=>x.invoice===no);
  const jml = +document.getElementById('bayarCicil').value;
  if(jml<=0 || jml>t.sisa){ Swal.fire('Nominal salah','','error'); return; }

  t.cicilan.push({tgl:new Date().toLocaleDateString(), jumlah:jml});
  t.sisa -= jml;
  if(t.sisa===0) t.status='Lunas';

  localStorage.setItem('transaksi',JSON.stringify(transaksi));
  Swal.fire('Berhasil','Pembayaran dicatat','success');
  render();
}

function logout(){ localStorage.removeItem('loginUser'); location.href='login.html'; }
render();
</script>
</body>
</html>
